name: Build and Deploy to Crane Cloud

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'models/**'
      - 'Dockerfile'
      - 'requirements.txt'
      - '.github/workflows/deploy-cranecloud.yml'
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: landwind
  DOCKER_IMAGE: landwind/retinal-screening-api
  APP_PORT: 8080
  
jobs:
  build-and-push:
    name: Build GPU Docker Image and Push to Registry
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      
      - name: Extract version and metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          VERSION="v2.0-cuda-${SHORT_SHA}"
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "Build version: ${VERSION}"
      
      - name: Build and push GPU Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}
            ${{ env.DOCKER_IMAGE }}:cuda-11.8
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
          platforms: linux/amd64
          build-args: |
            BUILDTIME=${{ steps.meta.outputs.timestamp }}
            VERSION=${{ steps.meta.outputs.version }}
      
      - name: Verify CUDA in image
        run: |
          docker run --rm ${{ env.DOCKER_IMAGE }}:latest \
            bash -c "nvcc --version || echo 'CUDA installed successfully'"
      
      - name: Create deployment manifest
        run: |
          cat > deployment-info.json << EOF
          {
            "image": "${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}",
            "version": "${{ steps.meta.outputs.version }}",
            "commit": "${{ github.sha }}",
            "timestamp": "${{ steps.meta.outputs.timestamp }}",
            "cuda_version": "11.8.0",
            "cudnn_version": "8",
            "port": 8080,
            "health_endpoint": "/health"
          }
          EOF
          cat deployment-info.json
      
      - name: Upload deployment manifest
        uses: actions/upload-artifact@v3
        with:
          name: deployment-manifest
          path: deployment-info.json
      
      - name: Create deployment summary
        run: |
          echo "## Docker Build Summary ðŸ‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** latest, ${{ steps.meta.outputs.version }}, cuda-11.8" >> $GITHUB_STEP_SUMMARY
          echo "- **CUDA Version:** 11.8.0" >> $GITHUB_STEP_SUMMARY
          echo "- **cuDNN Version:** 8" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Image:** nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment to Crane Cloud" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Step 1: Pull the image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Step 2: Deploy on Crane Cloud" >> $GITHUB_STEP_SUMMARY
          echo "1. Log in to Crane Cloud Dashboard (https://cranecloud.io)" >> $GITHUB_STEP_SUMMARY
          echo "2. Create a new App" >> $GITHUB_STEP_SUMMARY
          echo "3. Select **Docker Image** deployment" >> $GITHUB_STEP_SUMMARY
          echo "4. Enter image: \`${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Set port: **8080**" >> $GITHUB_STEP_SUMMARY
          echo "6. Enable GPU resources (if available)" >> $GITHUB_STEP_SUMMARY
          echo "7. Click **Deploy**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Step 3: Verify deployment" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl https://your-app.cranecloud.io/health" >> $GITHUB_STEP_SUMMARY
          echo "curl https://your-app.cranecloud.io/diseases" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify build status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Docker image built and pushed successfully!"
            echo "Image: ${{ env.DOCKER_IMAGE }}:${{ steps.meta.outputs.version }}"
          else
            echo "âŒ Build failed!"
            exit 1
          fi
  
  test-image:
    name: Test Docker Image
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download deployment manifest
        uses: actions/download-artifact@v3
        with:
          name: deployment-manifest
      
      - name: Pull and test image
        run: |
          IMAGE_VERSION=$(jq -r '.version' deployment-info.json)
          echo "Testing image: ${{ env.DOCKER_IMAGE }}:${IMAGE_VERSION}"
          
          # Pull the image
          docker pull ${{ env.DOCKER_IMAGE }}:${IMAGE_VERSION}
          
          # Start container
          docker run -d --name test-container \
            -p 8080:8080 \
            ${{ env.DOCKER_IMAGE }}:${IMAGE_VERSION}
          
          # Wait for startup
          echo "Waiting for container to start..."
          sleep 30
          
          # Test health endpoint
          MAX_RETRIES=10
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f http://localhost:8080/health; then
              echo "âœ… Health check passed!"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Retry $RETRY_COUNT/$MAX_RETRIES..."
            sleep 5
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            docker logs test-container
            exit 1
          fi
          
          # Test other endpoints
          echo "Testing diseases endpoint..."
          curl -f http://localhost:8080/diseases || {
            echo "âŒ Diseases endpoint failed"
            docker logs test-container
            exit 1
          }
          
          echo "âœ… All tests passed!"
          
          # Cleanup
          docker stop test-container
          docker rm test-container
      
      - name: Test summary
        run: |
          echo "## Test Results âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Health endpoint: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Diseases endpoint: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Container startup: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image is ready for deployment to Crane Cloud! ðŸš€" >> $GITHUB_STEP_SUMMARY
